<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Predictive Maintenance System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Plotly.js for Charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        :root {
            --primary-dark: #0f172a;
            --primary-blue: #1e40af;
            --success-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --card-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-light: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* CRITICAL ALERT SCREEN BLINK */
        body.critical-alert {
            animation: criticalBlink 1s infinite alternate;
        }

        @keyframes criticalBlink {
            0% { 
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #dc2626 100%);
                box-shadow: inset 0 0 100px rgba(220, 38, 38, 0.5);
            }
            100% { 
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #ef4444 100%);
                box-shadow: inset 0 0 100px rgba(239, 68, 68, 0.7);
            }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Header Enhancements */
        .main-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(5, 150, 105, 0.2);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #059669;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #059669;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Container Enhancement */
        .main-container {
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            margin: 20px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .main-container.critical-mode {
            border: 3px solid #dc2626;
            box-shadow: 0 0 50px rgba(220, 38, 38, 0.5);
        }

        /* Dashboard Title */
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-blue));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 40px;
        }

        /* Enhanced Statistics Row */
        .stats-row {
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.stat-primary::before { background: linear-gradient(90deg, var(--primary-blue), #3b82f6); }
        .stat-card.stat-success::before { background: linear-gradient(90deg, var(--success-green), #10b981); }
        .stat-card.stat-info::before { background: linear-gradient(90deg, #0ea5e9, #0284c7); }
        .stat-card.stat-warning::before { background: linear-gradient(90deg, var(--warning-orange), #f59e0b); }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            margin-bottom: 15px;
        }

        .stat-primary .stat-icon { background: linear-gradient(135deg, var(--primary-blue), #3b82f6); }
        .stat-success .stat-icon { background: linear-gradient(135deg, var(--success-green), #10b981); }
        .stat-info .stat-icon { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .stat-warning .stat-icon { background: linear-gradient(135deg, var(--warning-orange), #f59e0b); }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Machine Grid Layout */
        .machines-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Professional Machine Cards */
        .machine-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .machine-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* CRITICAL MACHINE EFFECTS */
        .machine-card.critical-machine {
            border: 3px solid #dc2626;
            animation: machineCritical 1.5s infinite;
        }

        @keyframes machineCritical {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(220, 38, 38, 0.6);
                transform: translateY(-5px);
            }
            50% { 
                box-shadow: 0 0 40px rgba(239, 68, 68, 0.8);
                transform: translateY(-8px);
            }
        }

        .machine-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .machine-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 20px 25px;
            color: white;
            position: relative;
        }

        .machine-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .machine-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 12px;
        }

        .machine-location {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            position: absolute;
            top: 20px;
            right: 25px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-normal { background: rgba(5, 150, 105, 0.2); color: #059669; border: 1px solid rgba(5, 150, 105, 0.3); }
        .status-maintenance { background: rgba(217, 119, 6, 0.2); color: #d97706; border: 1px solid rgba(217, 119, 6, 0.3); }
        .status-sabotage { background: rgba(220, 38, 38, 0.2); color: #dc2626; border: 1px solid rgba(220, 38, 38, 0.3); }
        .status-shutdown { background: rgba(75, 85, 99, 0.2); color: #4b5563; border: 1px solid rgba(75, 85, 99, 0.3); }

        .machine-body {
            padding: 25px;
        }

        /* Sensor Metrics Grid */
        .sensor-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .sensor-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .sensor-item.normal {
            border-color: var(--success-green);
            background: rgba(5, 150, 105, 0.05);
        }

        .sensor-item.warning {
            border-color: var(--warning-orange);
            background: rgba(217, 119, 6, 0.05);
        }

        .sensor-item.critical {
            border-color: var(--danger-red);
            background: rgba(220, 38, 38, 0.05);
            animation: pulse-critical 2s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
        }

        .sensor-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .sensor-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sensor-value.normal { color: var(--success-green); }
        .sensor-value.warning { color: var(--warning-orange); }
        .sensor-value.critical { color: var(--danger-red); }

        .sensor-score {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Mini Chart Container */
        .mini-chart {
            height: 120px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 5px;
            border: 1px solid #e2e8f0;
        }

        /* Enhanced Control Buttons */
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .control-btn {
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-normal {
            background: linear-gradient(135deg, var(--success-green), #10b981);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-maintenance {
            background: linear-gradient(135deg, var(--warning-orange), #f59e0b);
            color: white;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
        }

        .btn-sabotage {
            background: linear-gradient(135deg, var(--danger-red), #ef4444);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        /* EMERGENCY SHUTDOWN BUTTON */
        .btn-shutdown {
            background: linear-gradient(135deg, #4b5563, #374151);
            color: white;
            box-shadow: 0 4px 15px rgba(75, 85, 99, 0.3);
        }

        .btn-shutdown.emergency {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            animation: emergencyPulse 1s infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 6px 25px rgba(220, 38, 38, 0.8);
                transform: scale(1.05);
            }
        }

        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            z-index: 999;
            background: linear-gradient(135deg, var(--danger-red), #dc2626);
            color: white;
            padding: 15px;
            text-align: center;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .machines-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .main-container {
                margin: 10px;
                padding: 20px;
            }

            .control-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Loading States */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 400% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }

        /* CRITICAL OVERLAY */
        .critical-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(220, 38, 38, 0.1);
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .critical-overlay.active {
            opacity: 1;
            animation: overlayPulse 2s infinite;
        }

        @keyframes overlayPulse {
            0%, 100% { background: rgba(220, 38, 38, 0.05); }
            50% { background: rgba(220, 38, 38, 0.15); }
        }
    </style>
</head>
<body>
    <!-- Critical Overlay -->
    <div id="critical-overlay" class="critical-overlay"></div>

    <!-- Professional Header -->
    <header class="main-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center py-3">
                <div class="brand-logo">
                    <i class="fas fa-industry me-2"></i>
                    <strong>Industrial Predictive Maintenance</strong>
                </div>

                <div class="d-flex align-items-center gap-4">
                    <div class="status-indicator">
                        <div class="pulse-dot"></div>
                        <span>System Online</span>
                    </div>

                    <div class="text-white d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-bell"></i>
                            <span class="badge bg-warning text-dark" id="alert-count">0</span>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-clock"></i>
                            <span id="current-time"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Critical Alert Banner -->
    <div id="critical-alert-banner" class="alert-banner d-none" role="alert">
        <div class="container-fluid">
            <h6 class="mb-1">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>ðŸš¨ EMERGENCY CRITICAL ALERT - IMMEDIATE ACTION REQUIRED</strong>
            </h6>
            <p class="mb-0" id="critical-alert-message">Critical anomaly detected in industrial equipment.</p>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="main-container" id="main-container">
        <!-- Dashboard Header -->
        <div class="text-center mb-5">
            <h1 class="dashboard-title">
                <i class="fas fa-tachometer-alt me-3"></i>
                Industrial Control Center
            </h1>
            <p class="dashboard-subtitle">
                Real-time monitoring and predictive maintenance for chemical & biotechnology processes
            </p>
        </div>

        <!-- Enhanced Statistics Overview -->
        <div class="row stats-row">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="stat-value" id="total-machines">{{ machines|length }}</div>
                    <div class="stat-label">Active Machines</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card stat-success">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="operational-count">-</div>
                    <div class="stat-label">Operational Units</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card stat-info">
                    <div class="stat-icon">
                        <i class="fas fa-stopwatch"></i>
                    </div>
                    <div class="stat-value" id="total-runtime">-</div>
                    <div class="stat-label">System Uptime (hrs)</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value" id="efficiency-rate">-</div>
                    <div class="stat-label">Overall Efficiency</div>
                </div>
            </div>
        </div>

        <!-- 2x2 Machine Grid -->
        <div class="machines-grid" id="machines-grid">
            <!-- Machines will be dynamically loaded here -->
            {% for machine in machines %}
            <div class="machine-card" data-machine-id="{{ machine.id }}" id="machine-card-{{ machine.id }}">
                <div class="machine-header">
                    <div class="machine-title">
                        <i class="fas fa-cog"></i>
                        {{ machine.name }}
                    </div>
                    <div class="machine-subtitle">{{ machine.description }}</div>
                    <div class="machine-location">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ machine.location }}
                    </div>
                    <span class="status-badge status-normal" id="status-{{ machine.id }}">
                        {{ machine.status.upper() }}
                    </span>
                </div>

                <div class="machine-body">
                    <!-- Sensor Metrics Grid -->
                    <div class="sensor-metrics" id="sensors-{{ machine.id }}">
                        <div class="sensor-item loading-shimmer">
                            <div class="sensor-label">Loading...</div>
                            <div class="sensor-value">--</div>
                        </div>
                        <div class="sensor-item loading-shimmer">
                            <div class="sensor-label">Loading...</div>
                            <div class="sensor-value">--</div>
                        </div>
                        <div class="sensor-item loading-shimmer">
                            <div class="sensor-label">Loading...</div>
                            <div class="sensor-value">--</div>
                        </div>
                        <div class="sensor-item loading-shimmer">
                            <div class="sensor-label">Loading...</div>
                            <div class="sensor-value">--</div>
                        </div>
                    </div>

                    <!-- Mini Chart -->
                    <div class="mini-chart" id="chart-{{ machine.id }}"></div>

                    <!-- Enhanced Control Buttons -->
                    <div class="control-buttons" id="controls-{{ machine.id }}">
                        <button class="control-btn btn-normal" onclick="setMachineMode({{ machine.id }}, 'normal')" id="btn-normal-{{ machine.id }}">
                            <i class="fas fa-play me-1"></i>Start
                        </button>
                        <button class="control-btn btn-maintenance" onclick="setMachineMode({{ machine.id }}, 'maintenance')" id="btn-maintenance-{{ machine.id }}">
                            <i class="fas fa-wrench me-1"></i>Maintenance
                        </button>
                        <button class="control-btn btn-sabotage" onclick="setMachineMode({{ machine.id }}, 'sabotage')" id="btn-sabotage-{{ machine.id }}">
                            <i class="fas fa-exclamation-triangle me-1"></i>Critical
                        </button>
                        <button class="control-btn btn-shutdown" onclick="emergencyShutdown({{ machine.id }})" id="btn-shutdown-{{ machine.id }}">
                            <i class="fas fa-power-off me-1"></i>Shutdown
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let machines = [];
        let chartData = {};
        let miniCharts = {};
        let criticalMachines = new Set();
        let shutdownMachines = new Set();
        let systemStartTime = new Date();

        // Enhanced Chart Colors for Different Lines
        const CHART_COLORS = [
            '#ff6b6b',  // Red
            '#4ecdc4',  // Teal  
            '#45b7d1',  // Blue
            '#f9ca24',  // Yellow
            '#6c5ce7',  // Purple
            '#a0e7e5',  // Light teal
            '#ffeaa7',  // Light yellow
            '#fd79a8'   // Pink
        ];

        // Machine Configurations
        const MACHINE_CONFIGS = {
            "Chemical Reactor": {
                icon: "fas fa-flask",
                sensors: ["temperature", "pressure", "flow_rate", "level"]
            },
            "Biotech Fermenter": {
                icon: "fas fa-seedling", 
                sensors: ["temperature", "ph", "dissolved_oxygen", "agitation"]
            },
            "Distillation Column": {
                icon: "fas fa-filter",
                sensors: ["temperature_top", "temperature_bottom", "pressure", "reflux_ratio"]
            },
            "Heat Exchanger": {
                icon: "fas fa-fire",
                sensors: ["inlet_temp", "outlet_temp", "pressure_drop", "flow_rate"]
            }
        };

        // Initialize dashboard
        function initializeDashboard() {
            updateTime();
            loadMachines();

            // Set update intervals
            setInterval(updateTime, 1000);
            setInterval(() => {
                updateMachineData();
                updateStatistics();
            }, 5000);
            setInterval(checkAlerts, 8000);
        }

        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
        }

        function loadMachines() {
            fetch('/api/machines')
                .then(response => response.json())
                .then(data => {
                    machines = data;
                    console.log('âœ… Loaded machines:', machines.length);

                    document.getElementById('total-machines').textContent = machines.length;

                    initializeCharts();
                    updateMachineData();
                    updateStatistics();
                })
                .catch(error => {
                    console.error('âŒ Error loading machines:', error);
                });
        }

        function initializeCharts() {
            machines.forEach((machine, machineIndex) => {
                const config = MACHINE_CONFIGS[machine.machine_type];
                if (!config) return;

                // Initialize chart data storage
                chartData[machine.id] = {};
                config.sensors.forEach(sensor => {
                    chartData[machine.id][sensor] = { x: [], y: [], anomalies: [] };
                });

                // Create mini chart with different colors for each line
                const traces = config.sensors.map((sensor, index) => ({
                    x: [], y: [], type: 'scatter', mode: 'lines',
                    name: sensor.replace('_', ' ').toUpperCase(),
                    line: { 
                        width: 3, 
                        color: CHART_COLORS[index % CHART_COLORS.length]
                    }
                }));

                const layout = {
                    margin: { l: 25, r: 25, t: 15, b: 25 },
                    showlegend: false,
                    xaxis: { visible: false },
                    yaxis: { visible: false },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot(`chart-${machine.id}`, traces, layout, {
                    responsive: true,
                    displayModeBar: false
                });

                console.log(`ðŸ“Š Colorful chart initialized for ${machine.name}`);
            });
        }

        function updateMachineData() {
            machines.forEach(machine => {
                if (shutdownMachines.has(machine.id)) {
                    return; // Skip updates for shutdown machines
                }

                fetch(`/api/machine/${machine.id}/latest`)
                    .then(response => response.json())
                    .then(data => {
                        updateMachineCard(machine.id, data);
                        updateMiniChart(machine.id, data);
                        checkCriticalCondition(machine.id, data);
                    })
                    .catch(error => console.error('Error:', error));
            });
        }

        function updateMachineCard(machineId, data) {
            const machine = data.machine;
            const readings = data.readings;

            // Update status badge
            const statusBadge = document.getElementById(`status-${machineId}`);
            if (statusBadge && !shutdownMachines.has(machineId)) {
                statusBadge.textContent = machine.status.toUpperCase();
                statusBadge.className = `status-badge status-${machine.status}`;
            }

            // Update sensor grid
            const sensorsGrid = document.getElementById(`sensors-${machineId}`);
            if (sensorsGrid && Object.keys(readings).length > 0) {
                const sensorEntries = Object.entries(readings).slice(0, 4);

                sensorsGrid.innerHTML = sensorEntries.map(([sensorType, reading]) => {
                    const status = reading.is_anomaly ? (reading.anomaly_score > 0.8 ? 'critical' : 'warning') : 'normal';
                    const icon = reading.is_anomaly ? 
                        (reading.anomaly_score > 0.8 ? 'fa-exclamation-triangle' : 'fa-exclamation-circle') : 
                        'fa-check-circle';

                    return `
                        <div class="sensor-item ${status}">
                            <div class="sensor-label">${sensorType.replace('_', ' ')}</div>
                            <div class="sensor-value ${status}">
                                <i class="fas ${icon}"></i>
                                ${reading.value} ${reading.unit}
                            </div>
                            <div class="sensor-score">${(reading.anomaly_score * 100).toFixed(1)}%</div>
                        </div>
                    `;
                }).join('');
            }

            // Update control buttons based on machine state
            updateControlButtons(machineId, machine.status);
        }

        function updateMiniChart(machineId, data) {
            if (!chartData[machineId] || !data.readings) return;

            const currentTime = new Date(data.timestamp);
            const readings = data.readings;

            // Update chart data
            Object.entries(readings).forEach(([sensorType, reading]) => {
                if (chartData[machineId][sensorType]) {
                    chartData[machineId][sensorType].x.push(currentTime);
                    chartData[machineId][sensorType].y.push(reading.value);
                    chartData[machineId][sensorType].anomalies.push(reading.is_anomaly);

                    // Keep only last 20 points for mini charts
                    if (chartData[machineId][sensorType].x.length > 20) {
                        chartData[machineId][sensorType].x.shift();
                        chartData[machineId][sensorType].y.shift();
                        chartData[machineId][sensorType].anomalies.shift();
                    }
                }
            });

            // Update Plotly mini chart with colors
            const config = MACHINE_CONFIGS[machines.find(m => m.id === machineId)?.machine_type];
            if (!config) return;

            const traces = config.sensors.map((sensor, index) => {
                const data = chartData[machineId][sensor];
                return {
                    x: data.x,
                    y: data.y,
                    type: 'scatter',
                    mode: 'lines',
                    line: { 
                        width: 3,
                        color: data.anomalies.some(a => a) ? '#dc2626' : CHART_COLORS[index % CHART_COLORS.length]
                    }
                };
            });

            if (traces.some(t => t.x.length > 0)) {
                Plotly.restyle(`chart-${machineId}`, {
                    x: traces.map(t => t.x),
                    y: traces.map(t => t.y),
                    'line.color': traces.map(t => t.line.color)
                });
            }
        }

        function updateControlButtons(machineId, status) {
            const isShutdown = shutdownMachines.has(machineId);

            const normalBtn = document.getElementById(`btn-normal-${machineId}`);
            const maintenanceBtn = document.getElementById(`btn-maintenance-${machineId}`);
            const sabotageBtn = document.getElementById(`btn-sabotage-${machineId}`);
            const shutdownBtn = document.getElementById(`btn-shutdown-${machineId}`);

            if (isShutdown) {
                // Machine is shutdown - only allow start
                normalBtn.disabled = false;
                maintenanceBtn.disabled = true;
                sabotageBtn.disabled = true;
                shutdownBtn.disabled = true;
                shutdownBtn.classList.remove('emergency');
            } else {
                // Machine is running - allow all controls
                normalBtn.disabled = false;
                maintenanceBtn.disabled = false;
                sabotageBtn.disabled = false;
                shutdownBtn.disabled = false;

                if (status === 'sabotage') {
                    shutdownBtn.classList.add('emergency');
                } else {
                    shutdownBtn.classList.remove('emergency');
                }
            }
        }

        // CRITICAL CONDITION CHECKER
        function checkCriticalCondition(machineId, data) {
            const readings = data.readings;
            let criticalSensors = 0;

            Object.entries(readings).forEach(([sensorType, reading]) => {
                if (reading.is_anomaly && reading.anomaly_score > 0.8) {
                    criticalSensors++;
                }
            });

            const machineCard = document.getElementById(`machine-card-${machineId}`);

            if (criticalSensors >= 2) {
                // CRITICAL CONDITION DETECTED
                criticalMachines.add(machineId);
                machineCard.classList.add('critical-machine');

                // TRIGGER SCREEN-WIDE EFFECTS
                activateCriticalMode();
            } else {
                // Normal condition
                criticalMachines.delete(machineId);
                machineCard.classList.remove('critical-machine');

                if (criticalMachines.size === 0) {
                    deactivateCriticalMode();
                }
            }
        }

        // CRITICAL MODE EFFECTS
        function activateCriticalMode() {
            document.body.classList.add('critical-alert');
            document.getElementById('main-container').classList.add('critical-mode');
            document.getElementById('critical-overlay').classList.add('active');
        }

        function deactivateCriticalMode() {
            document.body.classList.remove('critical-alert');
            document.getElementById('main-container').classList.remove('critical-mode');
            document.getElementById('critical-overlay').classList.remove('active');
        }

        // EMERGENCY SHUTDOWN FUNCTION
        function emergencyShutdown(machineId) {
            if (shutdownMachines.has(machineId)) {
                return; // Already shutdown
            }

            shutdownMachines.add(machineId);
            criticalMachines.delete(machineId);

            // Update UI immediately
            const statusBadge = document.getElementById(`status-${machineId}`);
            const machineCard = document.getElementById(`machine-card-${machineId}`);

            statusBadge.textContent = 'SHUTDOWN';
            statusBadge.className = 'status-badge status-shutdown';
            machineCard.classList.remove('critical-machine');

            // Clear sensor data
            const sensorsGrid = document.getElementById(`sensors-${machineId}`);
            sensorsGrid.innerHTML = `
                <div class="sensor-item" style="grid-column: 1 / -1;">
                    <div class="sensor-label">SYSTEM STATUS</div>
                    <div class="sensor-value" style="color: #4b5563;">
                        <i class="fas fa-power-off"></i>
                        EMERGENCY SHUTDOWN
                    </div>
                    <div class="sensor-score">Manual restart required</div>
                </div>
            `;

            // Update control buttons
            updateControlButtons(machineId, 'shutdown');

            // Check if all critical conditions resolved
            if (criticalMachines.size === 0) {
                deactivateCriticalMode();
            }

            showToast(`ðŸš¨ EMERGENCY SHUTDOWN: Machine ${machineId} shutdown successfully`, 'warning');
        }

        function updateStatistics() {
            const currentTime = new Date();
            const uptimeHours = Math.floor((currentTime - systemStartTime) / (1000 * 60 * 60));
            const uptimeMinutes = Math.floor(((currentTime - systemStartTime) % (1000 * 60 * 60)) / (1000 * 60));

            fetch('/api/machines')
                .then(response => response.json())
                .then(machines => {
                    const operationalCount = machines.filter(m => 
                        m.status === 'normal' && !shutdownMachines.has(m.id)
                    ).length;

                    const efficiency = Math.round((operationalCount / machines.length) * 100);

                    document.getElementById('operational-count').textContent = operationalCount;
                    document.getElementById('total-runtime').textContent = uptimeHours > 0 ? 
                        `${uptimeHours}h ${uptimeMinutes}m` : `${uptimeMinutes}m`;
                    document.getElementById('efficiency-rate').textContent = `${efficiency}%`;
                });
        }

        function setMachineMode(machineId, mode) {
            if (mode === 'normal' && shutdownMachines.has(machineId)) {
                // Restarting a shutdown machine
                shutdownMachines.delete(machineId);
                showToast(`ðŸ”„ Machine ${machineId} restarted successfully`, 'success');
            }

            fetch(`/api/machine/${machineId}/mode`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… Machine mode changed to ${mode.toUpperCase()}`, 'success');

                    // Clear chart data for fresh start
                    if (chartData[machineId]) {
                        Object.keys(chartData[machineId]).forEach(sensor => {
                            chartData[machineId][sensor] = { x: [], y: [], anomalies: [] };
                        });
                    }

                    setTimeout(() => {
                        updateMachineData();
                        updateStatistics();
                    }, 1500);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function checkAlerts() {
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    const criticalAlerts = alerts.filter(alert => 
                        !alert.is_acknowledged && 
                        alert.severity === 'critical' &&
                        alert.alert_type === 'critical'
                    );

                    document.getElementById('alert-count').textContent = alerts.filter(a => !a.is_acknowledged).length;

                    const banner = document.getElementById('critical-alert-banner');

                    if (criticalAlerts.length > 0 && criticalMachines.size > 0) {
                        document.getElementById('critical-alert-message').textContent = criticalAlerts[0].message;
                        banner.classList.remove('d-none');
                    } else {
                        banner.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error checking alerts:', error);
                    document.getElementById('critical-alert-banner').classList.add('d-none');
                });
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px; backdrop-filter: blur(20px);';
            toast.innerHTML = `
                <strong>${message}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.parentNode?.removeChild(toast), 5000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ Initializing Ultimate Industrial Dashboard...');
            initializeDashboard();
        });
    </script>
</body>
</html>